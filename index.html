<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ T√çTULO DE LA PESTA√ëA DEL NAVEGADOR -->
  <title>Cat√°logo ¬∑ Carrito</title>
  
  <style>

/* ‚úÖ ESTILOS GENERALES (COLORES Y ‚ÄúTEMA‚Äù DE LA WEB) Aqu√≠ defines los colores base y el look (fondo, textos, bordes, botones). */
    
    :root{--bg:#0b1220;--card:#101b33;--muted:#8ea0c6;--txt:#eaf0ff;--accent:#5eead4;--danger:#ff6b6b;--border:rgba(255,255,255,.10)}

    /* ‚úÖ REGLAS B√ÅSICAS PARA QUE TODO SE VEA ORDENADO */
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:linear-gradient(180deg,#070b14, var(--bg)); color:var(--txt)}

    /* ‚úÖ CABECERA FIJA (BUSCADOR, ICONO DEL CARRITO, BOT√ìN VACIAR) */
    header{position:sticky;top:0;z-index:10;background:rgba(7,11,20,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}

    /* ‚úÖ CONTENEDOR ‚ÄúCENTRADO‚Äù (ANCHO M√ÅXIMO) */
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px}

    /* ‚úÖ ESTRUCTURA DE LA PARTE SUPERIOR */
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:14px;background:radial-gradient(circle at 30% 20%, var(--accent), transparent 55%), linear-gradient(135deg,#2b2f55,#111a33); border:1px solid var(--border)}
    h1{font-size:18px;margin:0;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}

    /* ‚úÖ BUSCADOR, ‚ÄúP√çLDORAS‚Äù Y BOTONES DE LA CABECERA */
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.03);min-width:min(420px, 92vw)}
    .search input{width:100%;border:0;outline:0;background:transparent;color:var(--txt);font-size:14px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--txt);cursor:pointer;user-select:none}
    .pill strong{font-weight:700}
    .pill:hover{border-color:rgba(94,234,212,.35)}

    /* ‚úÖ LAYOUT PRINCIPAL: CATALOGO A LA IZQ / CARRITO A LA DER (EN M√ìVIL SE APILAN) */
    main .grid{display:grid;grid-template-columns:1.25fr .85fr;gap:16px;align-items:start}
    @media (max-width: 920px){main .grid{grid-template-columns:1fr}}

    /* ‚úÖ ‚ÄúCAJAS‚Äù TIPO PANEL PARA CATALOGO Y CARRITO */
    .panel{border:1px solid var(--border);border-radius:18px;background:rgba(255,255,255,.03);overflow:hidden}
    .panel h2{margin:0;padding:14px 14px;border-bottom:1px solid var(--border);font-size:14px;letter-spacing:.25px}
    .panel .content{padding:14px}

    /* ‚úÖ GRID DE PRODUCTOS (3 columnas / 2 / 1 seg√∫n pantalla) */
    .products{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:12px}
    @media (max-width: 920px){.products{grid-template-columns:repeat(2, minmax(0,1fr))}}
    @media (max-width: 520px){.products{grid-template-columns:1fr}}


    /* ‚úÖ TARJETAS DE PRODUCTO + BOTONES */
    .card{border:1px solid var(--border);border-radius:16px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02))}
    .tag{display:inline-flex;align-items:center;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .title{margin:10px 0 6px;font-size:14px;font-weight:700}
    .desc{margin:0 0 12px;color:var(--muted);font-size:12px;line-height:1.35}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .price{font-weight:800}
    .btn{border:1px solid rgba(94,234,212,.35);background:rgba(94,234,212,.10);color:var(--txt);padding:9px 10px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn:hover{background:rgba(94,234,212,.16)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{border-color:var(--border);background:rgba(255,255,255,.03)}
    .btn.danger{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.10)}

.btn.pay{
  border-color: rgba(94,234,212,.55);
  background: linear-gradient(180deg, rgba(94,234,212,.28), rgba(94,234,212,.12));
}
.btn.pay:hover{ filter: brightness(1.05); }
.btn.pay[aria-disabled="true"]{
  opacity:.45;
  pointer-events:none;
}
    
  
/* ‚úÖ IM√ÅGENES DE PRODUCTO */
.pimg{
  width:100%;
  aspect-ratio: 4 / 3;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  overflow:hidden;
  margin-bottom:10px;
}
.pimg img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}


    /* Para mostrar el stock bonito (unidades en existencia) */
    .stockline{display:flex;justify-content:space-between;align-items:center;margin:8px 0 10px}
    .stock{font-size:12px;color:var(--muted)}
    .badgeOut{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,107,107,.35);background:rgba(255,107,107,.10);color:var(--txt)}
    .btn[disabled]{opacity:.45;cursor:not-allowed}


    
    /* ‚úÖ CARRITO: LISTA DE ITEMS Y CONTROLES DE CANTIDAD */
    .cartList{display:flex;flex-direction:column;gap:10px}
    .cartItem{border:1px solid var(--border);border-radius:16px;padding:12px;background:rgba(255,255,255,.03)}
    .cartItem .name{font-weight:800;font-size:13px;margin:0 0 6px}
    .meta{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}

    .qty{display:inline-flex;align-items:center;gap:8px}
    .qty button{width:34px;height:34px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--txt);cursor:pointer;font-size:16px}
    .qty button:hover{border-color:rgba(94,234,212,.35)}
    .qty input{width:58px;text-align:center;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--txt);padding:8px 10px;outline:0}


    /* ‚úÖ TOTALES (SUBTOTAL / TOTAL) */
    .totals{border-top:1px solid var(--border);margin-top:12px;padding-top:12px}
    .totals .line{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
    .totals .grand{font-size:16px;font-weight:900}


    /* ‚úÖ PIE DE P√ÅGINA */
    .empty{color:var(--muted);font-size:13px;line-height:1.45;margin:0}
    footer{color:var(--muted);font-size:12px;text-align:center;padding:18px 16px}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px}

  
/* Para el carrito */
#cartPanel {
  scroll-margin-top: 90px;
}
    
  </style>
</head>
<body>

  
  <!-- ‚úÖ CABECERA: Marca + buscador + contador de carrito + vaciar -->
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Cat√°logo ¬∑ Carrito</h1>
          <div class="sub">Elige productos, ajusta cantidades y revisa el total.</div>
        </div>
      </div>
      <div class="actions">
        <div class="search" role="search">
          <span aria-hidden="true">üîé</span>
          <input id="q" type="search" placeholder="Buscar productos‚Ä¶" autocomplete="off" />
        </div>
        <div class="pill" id="cartCount" title="Productos en el carrito">üõí <strong>0</strong></div>
        <button class="pill" id="resetBtn" title="Vaciar carrito">üßπ Vaciar</button>
      </div>
    </div>
  </div>
</header>


  <!-- ‚úÖ CUERPO: 2 PANELES: CATALOGO (izq) + CARRITO (der) -->
<main>
  <div class="wrap">
    <div class="grid">


      <!-- ‚úÖ PANEL CATALOGO: aqu√≠ se ‚Äúpintan‚Äù las tarjetas de producto (JS rellena #products) -->
      <section class="panel" aria-label="Cat√°logo">
        <h2>Cat√°logo</h2>
        <div class="content">
          <div id="products" class="products"></div>
        </div>
      </section>


      <!-- ‚úÖ PANEL CARRITO: JS rellena #cart y calcula totales -->
      <aside class="panel" aria-label="Carrito" id="cartPanel">
        <h2>Carrito</h2>
        <div class="content">
          <div id="cart" class="cartList"></div>

          <div class="totals">
            <div class="line"><span class="muted">Productos</span><span id="itemsCount" class="muted">0</span></div>
            <div class="line"><span class="muted">Subtotal</span><span id="subtotal" class="muted">0,00 ‚Ç¨</span></div>
            <div class="line grand"><span>Total</span><span id="total">0,00 ‚Ç¨</span></div>

              <!-- ‚úÖ DATOS DEL CLIENTE: se env√≠an junto al pedido -->
            <div style="display:grid; gap:10px; margin:12px 0;">


              
              <input
  id="customerName"
  name="customerName"
  type="text"
  autocomplete="name"
  placeholder="Nombre y apellidos"
  style="padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);color:#eaf0ff;outline:0;"
>

<input
  id="customerPhone"
  name="customerPhone"
  type="tel"
  inputmode="tel"
  autocomplete="tel"
  placeholder="Tel√©fono"
  style="padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);color:#eaf0ff;outline:0;"
>

              
            </div>


   <!-- ‚úÖ BOTONES:
                   - Copiar resumen: √∫til para pegar en WhatsApp
                   - Exportar CSV: descargar archivo para Excel (manual)
                   - Confirmar pedido: env√≠a a Google Sheets (autom√°tico) -->
            
            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
  <a class="btn pay" id="payBtn" href="/checkout.html" role="button" aria-disabled="true">üí≥ Pagar</a>
</div>

            <p class="muted" style="margin:10px 0 0">Asegurese de ingresar los datos correctamente</p>
          </div>
        </div>
      </aside>

    </div>
  </div>
</main>




<!-- ‚úÖ ADMIN (solo t√∫) -->
<section class="panel" id="adminPanel" style="max-width:1100px;margin:16px auto;display:none;">
  <h2>Admin ¬∑ Productos e im√°genes</h2>
  <div class="content" style="display:grid;gap:12px;">

    <div id="adminAuthBox" style="display:grid;gap:10px;">
      <div class="muted">Acceso admin (solo para ti). Usa <code>?admin=1</code> en la URL.</div>
      <input id="adminEmail" placeholder="Email" style="padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);color:#eaf0ff;outline:0;">
      <input id="adminPass" type="password" placeholder="Contrase√±a" style="padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);color:#eaf0ff;outline:0;">
      <button class="btn" id="adminLoginBtn">Entrar</button>
    </div>

<div id="adminToolsBox" style="display:none; gap:12px;">
      <div class="muted">Modo admin activo ‚úÖ</div>

      <div style="display:grid;gap:10px;">
        <label class="muted">Producto</label>
        <select id="adminProduct" style="padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);color:#eaf0ff;outline:0;"></select>
      </div>

      <div style="display:grid;gap:10px;">
        <label class="muted">Imagen (JPG/PNG/WebP)</label>
        <input id="adminFile" type="file" accept="image/*"
          style="padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);color:#eaf0ff;outline:0;">
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" id="adminUploadBtn">Subir y asignar</button>
        <button class="btn secondary" id="adminRefreshBtn">Recargar productos</button>
        <button class="btn danger" id="adminLogoutBtn">Salir</button>
      </div>

      <div class="muted" id="adminStatus"></div>
    </div>

  </div>
</section>




  


  <!-- ‚úÖ PIE -->

<footer>
<code>¬© 2026 ¬∑ Mas Env√≠os ¬∑ Todos los derechos reservados</code>
</footer>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  
<script>
  const SUPABASE_URL = "https://pujzkraozoqbriqnlikf.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_D7A6JAiqiXAaPRYsaF6ZBQ_1hCE1UcN";

  // üëá cliente real (le ponemos otro nombre para evitar l√≠os)
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>


 
  
<script>


async function isAdmin(){
  const { data: { user } } = await sb.auth.getUser();
  if(!user) return false;

  const { data, error } = await sb
    .from('admins')
    .select('user_id')
    .eq('user_id', user.id)
    .maybeSingle();

  if(error) return false;
  return !!data;
}



function wantsAdminUI(){
  return new URLSearchParams(location.search).get('admin') === '1';
}



// üîê Cierra la sesi√≥n si NO est√°s en ?admin=1
async function autoLogoutIfNotAdminPage() {
  if (!wantsAdminUI()) {
    const { data: { user } } = await sb.auth.getUser();
    if (user) {
      await sb.auth.signOut();
      console.log("Admin session closed automatically ‚úÖ");
    }
  }
}


  

async function showAdminPanel(){
  const panel = document.getElementById('adminPanel');
  if(!panel) return;

  // Solo si entras con ?admin=1
  if(!wantsAdminUI()){
    panel.style.display = 'none';
    return;
  }


  

  panel.style.display = 'block';

  const authBox  = document.getElementById('adminAuthBox');
  const toolsBox = document.getElementById('adminToolsBox');

  const ok = await isAdmin();

  // Si es admin: muestra herramientas. Si no: muestra login
  if(ok){
    authBox.style.display = 'none';
    toolsBox.style.display = 'grid';
    fillAdminProducts();
  } else {
    toolsBox.style.display = 'none';
    authBox.style.display = 'grid';
  }
}

async function adminLogin(){
  const email = document.getElementById('adminEmail')?.value.trim();
  const pass  = document.getElementById('adminPass')?.value.trim();
  if(!email || !pass) return toast("Pon email y contrase√±a");

  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });

  if(error){
    console.error("LOGIN ERROR:", error);
    toast("Login fall√≥ ‚ùå " + (error.message || ""));
    return;
  }

  console.log("LOGIN OK:", data);
  toast("Login OK ‚úÖ");
  await loadProductsFromSupabase();
  await showAdminPanel();
}
  

async function adminLogout(){
  await sb.auth.signOut();
  toast("Sesi√≥n cerrada üëã");
  await showAdminPanel();
}

function fillAdminProducts(){
  const sel = document.getElementById('adminProduct');
  if(!sel) return;
  if(!PRODUCTS || PRODUCTS.length === 0) { sel.innerHTML = ''; return; }

  sel.innerHTML = '';
  PRODUCTS.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = `${p.name} (${p.id})`;
    sel.appendChild(opt);
  });
}

async function adminUploadAndAssign(){
  const status = document.getElementById('adminStatus');
  const sel = document.getElementById('adminProduct');
  const fileInput = document.getElementById('adminFile');
  const btn = document.getElementById('adminUploadBtn');

  if(!sel?.value) return toast("Selecciona un producto");
  const productId = sel.value;

  const file = fileInput?.files?.[0];
  if(!file) return toast("Selecciona una imagen");
  if(file.size > 3 * 1024 * 1024) return toast("Imagen muy grande (m√°x 3MB)");

  btn.disabled = true;
  const prev = btn.textContent;
  btn.textContent = "Subiendo‚Ä¶";
  if(status) status.textContent = "";

  try{
    const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
    const path = `products/${productId}.${ext}`;

    const { error: upErr } = await sb.storage
      .from('product-images')
      .upload(path, file, { upsert: true, contentType: file.type });

    if (upErr) {
  console.error(upErr);
  const msg = upErr.message || JSON.stringify(upErr);
  toast("Error subiendo imagen ‚ùå " + msg);
  if (status) status.textContent = msg;
  return;
}

    const { data: pub } = sb.storage.from('product-images').getPublicUrl(path);
    const publicUrl = pub?.publicUrl;
    if(!publicUrl) return toast("No pude obtener URL p√∫blica ‚ùå");

    const { error: updErr } = await sb
      .from('products')
      .update({ img: publicUrl })
      .eq('id', productId);

    if(updErr){
      console.error(updErr);
      toast("Error guardando en products ‚ùå");
      if(status) status.textContent = updErr.message || String(updErr);
      return;
    }

    toast("Imagen asignada ‚úÖ");
    if(status) status.textContent = "OK: " + publicUrl;

    await loadProductsFromSupabase();

  } finally {
    btn.disabled = false;
    btn.textContent = prev;
    if(fileInput) fileInput.value = "";
  }
}




  


  
  const $ = (s) => document.querySelector(s);

  let PRODUCTS = [];
  const productsEl = $('#products');
  const cartEl = $('#cart');
  const qEl = $('#q');

  const cartCountEl = $('#cartCount strong');
  const itemsCountEl = $('#itemsCount');
  const subtotalEl = $('#subtotal');
  const totalEl = $('#total');

  const STORAGE_KEY = 'cart_v1';
  let cart = loadCart();

  const eur = (n) =>
    new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);

  // ====== CARGAR PRODUCTOS (TABLA: products) ======
  async function loadProductsFromSupabase() {
    const { data, error } = await sb.from("products").select("*")
      .order("name", { ascending: true });

    if (error) {
      console.error(error);
      toast("Error cargando productos ‚ùå");
      return;
    }

    PRODUCTS = (data || []).map(row => ({
      id: row.id,
      name: row.name,
      category: row.category || "",
      price: Number(row.price) || 0,
      desc: row["desc"] || "",
      img: row.img || "img/placeholder.jpg",
      stock: Number(row.stock) || 0
    }));

    renderProducts();
    renderCart();
    fillAdminProducts();
  }

  // ====== TIEMPO REAL (TABLA: products) ======
  function subscribeRealtimeProducts() {
  sb
    .channel("realtime-products")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "products" },
      async () => {
  await loadProductsFromSupabase();   // carga stock
  const r = reconcileCartWithStock(false);

  if (r.changed) {
    renderCart();        // repinta
    updatePayButton();   // asegura el bot√≥n pagar
  }
}
    )
    .subscribe();
}

  // ====== LOCALSTORAGE ======
  function loadCart(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {};
      const parsed = JSON.parse(raw);
      return parsed && typeof parsed === 'object' ? parsed : {};
    } catch { return {}; }
  }
  function saveCart(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); }



  function getProduct(id){ return PRODUCTS.find(p => p.id === id); }
  function stockFor(id){ return Number(getProduct(id)?.stock) || 0; }

  

function reconcileCartWithStock(showToast = true) {
  let changed = false;
  const removed = [];
  const adjusted = [];

  for (const id of Object.keys(cart)) {
    const stock = stockFor(id);
    const qty = cart[id]?.qty || 0;

    // Si el producto ya ni existe en PRODUCTS o stock = 0 => fuera
    if (!getProduct(id) || stock <= 0) {
      delete cart[id];
      changed = true;
      removed.push(id);
      continue;
    }

    // Si el cliente lleva m√°s de lo que hay, lo ajustamos
    if (qty > stock) {
      cart[id].qty = stock;
      changed = true;
      adjusted.push({ id, from: qty, to: stock });
    }

    // Si qued√≥ en 0 por cualquier raz√≥n => fuera
    if ((cart[id]?.qty || 0) <= 0) {
      delete cart[id];
      changed = true;
      removed.push(id);
    }
  }

  if (changed) saveCart();

  if (showToast && changed) {
    if (removed.length) toast("Algunos productos se agotaron y se quitaron del carrito üßπ");
    else toast("Ajust√© cantidades seg√∫n stock disponible ‚úÖ");
  }

  return { changed, removed, adjusted };
}

// Revalidaci√≥n ‚Äúde verdad‚Äù: recarga desde Supabase y luego reconcilia
async function validateCartBeforePay() {
  await loadProductsFromSupabase();        // trae stock actual
  const result = reconcileCartWithStock(true);
  renderCart();                            // repinta con el carrito ya ajustado

  // Si despu√©s de ajustar qued√≥ vac√≠o, no dejes pagar
  const { distinct } = countsAndTotals();
  if (distinct <= 0) return { ok: false, reason: "empty" };

  return { ok: true, result };
}



  

  // ====== HELPERS ======
  function qtyInCart(id){ return cart[id]?.qty || 0; }

  function cartItems(){
    return Object.values(cart)
      .map(ci => ({...ci, product: getProduct(ci.id)}))
      .filter(x => x.product);
  }

  function countsAndTotals(){
    const items = cartItems();
    const distinct = items.length;
    const units = items.reduce((a, x) => a + x.qty, 0);
    const subtotal = items.reduce((a, x) => a + x.qty * x.product.price, 0);
    return { distinct, units, subtotal, total: subtotal };
  }

  // ====== RENDER ======
  function renderProducts(){
    const q = qEl.value.trim().toLowerCase();
    const list = PRODUCTS.filter(p => {
      if(!q) return true;
      return (p.name + ' ' + p.category + ' ' + (p.desc||'')).toLowerCase().includes(q);
    });

    productsEl.innerHTML = '';
    list.forEach(p => {
      const el = document.createElement('div');
      el.className = 'card';

      const inCart = qtyInCart(p.id);
      const stock = stockFor(p.id);
      const remaining = Math.max(0, stock - inCart);
      const out = stock <= 0;

      el.innerHTML = `
        <div class="pimg">
          <img src="${escapeHtml(p.img)}" alt="${escapeHtml(p.name)}" loading="lazy">
        </div>
        <div class="tag">${escapeHtml(p.category)}</div>
        <div class="title">${escapeHtml(p.name)}</div>
        <p class="desc">${escapeHtml(p.desc||'')}</p>

        <div class="stockline">
          <div class="stock">Unidades disponibles: <strong>${out ? 0 : remaining}</strong></div>
          ${out ? `<span class="badgeOut">Agotado</span>` : ``}
        </div>

        <div class="row">
          <div class="price">${eur(p.price)}</div>
          <button class="btn" data-add="${p.id}" ${out || remaining<=0 ? 'disabled' : ''}>
            ${out || remaining<=0 ? 'Sin stock' : 'A√±adir'}
          </button>
        </div>
      `;
      productsEl.appendChild(el);
    });

    productsEl.querySelectorAll('[data-add]').forEach(btn => {
      btn.addEventListener('click', () => addToCart(btn.getAttribute('data-add')));
    });
  }

  function renderCart(){
    const items = cartItems();
    cartEl.innerHTML = '';

    if(items.length === 0){
      cartEl.innerHTML = `<p class="empty">Tu carrito est√° vac√≠o.</p>`;
      updateTotals();
      renderProducts();
      updatePayButton();
      return;
    }

    items.forEach(({id, qty, product}) => {
      const lineTotal = qty * product.price;
      const el = document.createElement('div');
      el.className = 'cartItem';
      el.innerHTML = `
        <div class="name">${escapeHtml(product.name)}</div>
        <div class="meta">
          <div class="muted">${escapeHtml(product.category)} ¬∑ ${eur(product.price)} c/u</div>
          <div class="muted"><strong>${eur(lineTotal)}</strong></div>
        </div>
        <div class="meta" style="margin-top:10px">
          <div class="qty">
            <button data-dec="${id}">‚àí</button>
            <input data-qty="${id}" inputmode="numeric" pattern="[0-9]*" value="${qty}" />
            <button data-inc="${id}" ${qty >= stockFor(id) ? 'disabled' : ''}>+</button>
          </div>
          <button class="btn danger" data-rm="${id}">Quitar</button>
        </div>
      `;
      cartEl.appendChild(el);
    });

    cartEl.querySelectorAll('[data-inc]').forEach(b => b.addEventListener('click', () => changeQty(b.getAttribute('data-inc'), +1)));
    cartEl.querySelectorAll('[data-dec]').forEach(b => b.addEventListener('click', () => changeQty(b.getAttribute('data-dec'), -1)));
    cartEl.querySelectorAll('[data-rm]').forEach(b => b.addEventListener('click', () => removeFromCart(b.getAttribute('data-rm'))));

    cartEl.querySelectorAll('[data-qty]').forEach(inp => {
      inp.addEventListener('input', () => inp.value = inp.value.replace(/[^0-9]/g, ''));
      inp.addEventListener('change', () => {
        const id = inp.getAttribute('data-qty');
        const max = stockFor(id) || 1;
        const n = clampInt(inp.value, 1, max);
        setQty(id, n);
      });
    });

    updateTotals();
    renderProducts();
  }

  function updateTotals(){
    const { distinct, units, subtotal, total } = countsAndTotals();
    cartCountEl.textContent = String(distinct);
    itemsCountEl.textContent = `${distinct} producto(s) ¬∑ ${units} unidad(es)`;
    subtotalEl.textContent = eur(subtotal);
    totalEl.textContent = eur(total);

      updatePayButton();
  }


function updatePayButton(){
  const btn = document.getElementById('payBtn');
  if(!btn) return;

  const { distinct } = countsAndTotals();
  const canPay = distinct > 0;

  btn.setAttribute('aria-disabled', canPay ? 'false' : 'true');
  btn.title = canPay ? 'Ir a pagar' : 'A√±ade productos al carrito para pagar';
  btn.tabIndex = canPay ? 0 : -1;
  btn.style.pointerEvents = canPay ? "auto" : "none";
}

  

  // ====== CARRITO ======
  function addToCart(id){
    const stock = stockFor(id);
    const current = qtyInCart(id);
    if(stock <= 0) return toast("Producto sin stock ‚ùå");
    if(current >= stock) return toast("No hay m√°s unidades üôÇ");

    cart[id] = cart[id] || { id, qty: 0 };
    cart[id].qty += 1;
    saveCart();
    renderCart();
  }

  function removeFromCart(id){
    delete cart[id];
    saveCart();
    renderCart();
  }

  function setQty(id, qty){
    const max = stockFor(id);
    const safe = Math.min(Math.max(1, qty), max);
    cart[id] = cart[id] || { id, qty: 0 };
    cart[id].qty = safe;
    saveCart();
    renderCart();
  }

  function changeQty(id, delta){
    if(!cart[id]) return;
    const max = stockFor(id);
    const next = cart[id].qty + delta;
    if(next <= 0) return removeFromCart(id);
    cart[id].qty = Math.min(next, max);
    saveCart();
    renderCart();
  }

  function clearCart(){
    cart = {};
    saveCart();
    renderCart();
  }


  // ====== UI UTILS ======
  function clampInt(v, min, max){
    const n = parseInt(String(v||'').trim(), 10);
    if(Number.isNaN(n)) return min;
    return Math.min(max, Math.max(min, n));
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function toast(msg){
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position = 'fixed';
    el.style.left = '50%';
    el.style.bottom = '18px';
    el.style.transform = 'translateX(-50%)';
    el.style.padding = '10px 12px';
    el.style.borderRadius = '14px';
    el.style.border = '1px solid rgba(255,255,255,.14)';
    el.style.background = 'rgba(0,0,0,.55)';
    el.style.backdropFilter = 'blur(10px)';
    el.style.color = 'white';
    el.style.fontSize = '13px';
    el.style.zIndex = 9999;
    document.body.appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; el.style.transition='opacity .25s'; }, 1200);
    setTimeout(() => el.remove(), 1550);
  }

  // ====== INIT ======
  window.addEventListener("DOMContentLoaded", async () => {
  qEl.addEventListener('input', renderProducts);
  $('#resetBtn').addEventListener('click', clearCart);

  $('#cartCount').addEventListener('click', () => {
    $('#cartPanel')?.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  await loadProductsFromSupabase();        // ‚úÖ esperar productos reales
  reconcileCartWithStock(false);           // ‚úÖ ahora s√≠, con stock real
  renderCart();                            // ‚úÖ repinta con carrito ajustado
  subscribeRealtimeProducts();
  updatePayButton();


    document.getElementById("payBtn").addEventListener("click", async (e) => {
  e.preventDefault(); // üö´ no navegues todav√≠a

  const btn = e.currentTarget;
  const disabled = btn.getAttribute("aria-disabled") === "true";
  if (disabled) {
    toast("A√±ade productos antes de pagar üôÇ");
    return;
  }

  const name = (document.getElementById("customerName")?.value || "").trim();
  const phone = (document.getElementById("customerPhone")?.value || "").trim();
  if (!name || !phone) {
    toast("Falta nombre o tel√©fono");
    return;
  }

  // ‚úÖ 1) Validar stock real antes de pagar
  const check = await validateCartBeforePay();
  if (!check.ok) {
    toast("Se actualiz√≥ el stock y tu carrito qued√≥ vac√≠o üôÇ");
    return;
  }

  // ‚úÖ 2) Construir items ya con stock actualizado
  const items = cartItems().map(x => ({
    product_id: x.id,
    name: x.product.name,
    qty: x.qty,
    unit_price: x.product.price
  }));

  const { total } = countsAndTotals();
  const safeTotal = Math.round(total * 100) / 100;

  localStorage.setItem("checkout_total_eur", safeTotal.toString());
  localStorage.setItem("checkout_customer_name", name);
  localStorage.setItem("checkout_customer_phone", phone);
  localStorage.setItem("checkout_items", JSON.stringify(items));

  // ‚úÖ 3) Ahora s√≠, ir a pagar
  location.href = "./checkout.html";
});



      // üîê AUTO LOGOUT SI NO EST√ÅS EN ?admin=1
  await autoLogoutIfNotAdminPage();

    // Admin (solo si entras con ?admin=1)
await showAdminPanel();


// üîí Si est√°s en admin, al salir/cambiar de p√°gina se cierra sesi√≥n
if (wantsAdminUI()) {
  window.addEventListener("pagehide", async () => {
    await sb.auth.signOut();
  });
}
    

document.getElementById('adminLoginBtn')?.addEventListener('click', adminLogin);
document.getElementById('adminLogoutBtn')?.addEventListener('click', adminLogout);
document.getElementById('adminUploadBtn')?.addEventListener('click', adminUploadAndAssign);

document.getElementById('adminRefreshBtn')?.addEventListener('click', async () => {
  await loadProductsFromSupabase();
  fillAdminProducts();
  toast("Productos recargados ‚úÖ");
});

    
  });
  
</script>


  
</body>
</html>
