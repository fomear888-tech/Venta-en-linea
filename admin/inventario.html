<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ¬∑ Inventario</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f9fafb; --card:#fff; --txt:#111827; --muted:#6b7280;
      --border:rgba(0,0,0,.08); --accent:#10b981; --danger:#ef4444;
      --shadow:0 10px 28px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:var(--bg);color:var(--txt);padding:18px
    }
    .wrap{max-width:1200px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:12px;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:800;
      display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:var(--txt)
    }
    .btn.primary{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.12)}
    .btn.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:18px;box-shadow:var(--shadow);padding:14px
    }
    .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    input, textarea{
      border:1px solid var(--border);border-radius:12px;padding:10px 12px;outline:none;
      width:100%;font-family:inherit;font-size:14px;background:#fff
    }
    textarea{min-height:90px;resize:vertical}
    .search{max-width:420px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted)}



    .sortArrows{
  display:inline-flex;
  gap:6px;
  margin-left:8px;
  vertical-align:middle;
}
.sortArrows span{
  cursor:pointer;
  user-select:none;
  opacity:.45;
  font-size:12px;
  line-height:1;
}
.sortArrows span.active{
  opacity:1;
}




    
    tr:hover{background:#f3f4f6}
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .pill{font-size:11px;font-weight:800;border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#fff}
    .actions{display:flex;gap:8px;align-items:center}
    .iconbtn{
      border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900
    }
    .empty{padding:20px;text-align:center;color:var(--muted)}

    /* Modal */
    .modalOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:99
    }
    


.modal{
  width: min(860px, 100%);
  max-height: 90vh;              /* üëà clave */
  background:#fff;
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:0 30px 80px rgba(0,0,0,.18);
  padding:14px;
  display: flex;
  flex-direction: column;
}



.modalBody{
  overflow-y: auto;        /* üëà scroll vertical */
  padding-right: 6px;
  margin-top: 6px;
}

/* Scroll bonito (opcional pero elegante üòé) */
.modalBody::-webkit-scrollbar{
  width: 8px;
}
.modalBody::-webkit-scrollbar-thumb{
  background: rgba(0,0,0,.25);
  border-radius: 10px;
}
.modalBody::-webkit-scrollbar-track{
  background: transparent;
}




    
    

    .modal header{margin:0 0 10px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .rowline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .label{font-size:12px;color:var(--muted);font-weight:800;margin:6px 0}
    .imgRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .imgBox{border:1px dashed rgba(0,0,0,.22);border-radius:14px;padding:10px}
    .imgBox small{display:block;color:var(--muted);margin-top:6px}
    .modalFooter{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <h1>üì¶ Inventario</h1>
    <div class="rowline">
      <a class="btn" href="./pedidos.html">‚¨ÖÔ∏è Volver a pedidos</a>
      <button class="btn primary" id="newBtn">‚ûï Nuevo producto</button>
      <button class="btn primary" id="reloadBtn">üîÑ Recargar</button>
      <button class="btn danger" id="logoutBtn">üö™ Salir</button>
      
    </div>
  </header>

  <div class="card">
    <div class="topbar">
      <div class="search">
        <input id="q" placeholder="Buscar por id, nombre, categor√≠a..." />
        <div class="hint">Tip: escribe ‚Äúp01‚Äù o ‚Äútelefono‚Äù o ‚Äúhumidificador‚Äù üòÑ</div>
      </div>
      <span class="pill" id="countPill">0 productos</span>
    </div>

    <table>
      <thead>
        <tr>

          
          <th>
  ID
  <span class="sortArrows">
    <span id="sortUp" title="Orden ascendente">‚¨ÜÔ∏è</span>
    <span id="sortDown" title="Orden descendente">‚¨áÔ∏è</span>
  </span>
</th>

          <th>Nombre</th>
          <th>Categor√≠a</th>
          <th>Precio</th>
          <th>Stock</th>
          <th>Descripci√≥n</th>
          <th>Actualizado</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="8" class="empty">Cargando inventario‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- MODAL -->
<div class="modalOverlay" id="overlay">
  <div class="modal">
    <header>
      <h1 style="margin:0;font-size:16px">‚úèÔ∏è Editar producto</h1>
      <div class="muted" id="m_id"></div>
    </header>


  <div class="modalBody">


    
    <div class="grid">
      <div>
        <div class="label">Nombre</div>
        <input id="m_name" />
      </div>
      <div>
        <div class="label">Categor√≠a</div>
        <input id="m_category" placeholder="ej: Telefon√≠a, Hogar..." />
      </div>
    </div>

    <div class="grid3" style="margin-top:10px">
      <div>
        <div class="label">Precio (‚Ç¨)</div>
        <input id="m_price" type="number" step="0.01" />
      </div>
      <div>
        <div class="label">Stock</div>
        <input id="m_stock" type="number" step="1" />
      </div>
      <div>
        <div class="label">ID (solo lectura)</div>
        <input id="m_id_read" class="mono" placeholder="p083" />
<div class="hint">En edici√≥n no se cambia el ID. En ‚ÄúNuevo‚Äù s√≠ lo eliges.</div>

      </div>
    </div>

    <div style="margin-top:10px">
      <div class="label">Descripci√≥n</div>
      <textarea id="m_desc" placeholder="Descripci√≥n del producto..."></textarea>
    </div>

    <div style="margin-top:12px">
      <div class="label">Im√°genes (m√°x. 5) ‚Äî el orden importa (1¬™ es la principal)</div>

      <div class="imgRow">
        <div class="imgBox">
          <b>Imagen 1 (img)</b>
          <input id="m_img1" type="file" accept="image/*" />
          <small id="m_img1_cur">Actual: -</small>
        </div>
        <div class="imgBox">
          <b>Imagen 2 (img2)</b>
          <input id="m_img2" type="file" accept="image/*" />
          <small id="m_img2_cur">Actual: -</small>
        </div>

        <div class="imgBox">
          <b>Imagen 3 (img3)</b>
          <input id="m_img3" type="file" accept="image/*" />
          <small id="m_img3_cur">Actual: -</small>
        </div>
        <div class="imgBox">
          <b>Imagen 4 (img4)</b>
          <input id="m_img4" type="file" accept="image/*" />
          <small id="m_img4_cur">Actual: -</small>
        </div>

        <div class="imgBox" style="grid-column:1 / -1">
          <b>Imagen 5 (img5)</b>
          <input id="m_img5" type="file" accept="image/*" />
          <small id="m_img5_cur">Actual: -</small>
        </div>
      </div>

      <div class="hint">Las im√°genes se subir√°n a Storage: <span class="mono">product-images/products/&lt;ID&gt;/1.jpg</span> etc.</div>
    </div>



  </div>



    
    <div class="modalFooter">
      <button class="btn" id="m_cancel">Cancelar</button>
      <button class="btn primary" id="m_save">Guardar cambios</button>
    </div>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const SUPABASE_URL = "https://pujzkraozoqbriqnlikf.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_D7A6JAiqiXAaPRYsaF6ZBQ_1hCE1UcN";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const BUCKET = "product-images";
  const TABLE_PRODUCTS = "products";
  const TABLE_ADMINS = "admins";

  // ===== DOM =====
  const rows = document.getElementById("rows");
  const q = document.getElementById("q");
  const countPill = document.getElementById("countPill");

  const overlay = document.getElementById("overlay");
  const el = (id) => document.getElementById(id);

  let all = [];
  let current = null;
  let isNew = false;
  let sortDir = "asc"; // asc | desc




function openNew(){
  isNew = true;
  current = null;

  el("m_id").textContent = `Nuevo producto`;
  el("m_id_read").value = "";
  el("m_id_read").disabled = false;

  el("m_name").value = "";
  el("m_category").value = "";
  el("m_price").value = "";
  el("m_stock").value = "";
  el("m_desc").value = "";

  ["m_img1","m_img2","m_img3","m_img4","m_img5"].forEach(x => el(x).value = "");

  // links actuales vac√≠os
  setCur("m_img1_cur", null);
  setCur("m_img2_cur", null);
  setCur("m_img3_cur", null);
  setCur("m_img4_cur", null);
  setCur("m_img5_cur", null);

  overlay.style.display = "flex";
}



  
  
  function eur(n){
    return Number(n || 0).toFixed(2);
  }
  function fmtDate(ts){
    if(!ts) return "-";
    return new Date(ts).toLocaleString("es-ES");
  }

  async function isAdmin(){
    const { data: { user } } = await sb.auth.getUser();
    if(!user) return false;

    const { data, error } = await sb
      .from(TABLE_ADMINS)
      .select("user_id")
      .eq("user_id", user.id)
      .maybeSingle();

    if(error) return false;
    return !!data;
  }

  async function loadProducts(){
    rows.innerHTML = `<tr><td colspan="8" class="empty">Cargando inventario‚Ä¶</td></tr>`;

    const { data, error } = await sb
      .from(TABLE_PRODUCTS)
      .select("id,name,category,price,stock,desc,img,img2,img3,img4,img5,updated_at")
      .order("updated_at", { ascending:false });

    if(error){
      console.error(error);
      rows.innerHTML = `<tr><td colspan="8" class="empty">Error cargando inventario</td></tr>`;
      return;
    }

    all = Array.isArray(data) ? data : [];
    applyFilter();
  }

  function applyFilter(){
    const term = (q.value || "").trim().toLowerCase();
    const filtered = !term ? all : all.filter(p => {
      const s = `${p.id||""} ${p.name||""} ${p.category||""} ${p.desc||""}`.toLowerCase();
      return s.includes(term);
    });


    filtered.sort((a,b) => {
  const A = String(a.id || "").toLowerCase();
  const B = String(b.id || "").toLowerCase();
  return sortDir === "asc" ? A.localeCompare(B) : B.localeCompare(A);
});
    

    countPill.textContent = `${filtered.length} productos`;

    if(filtered.length === 0){
      rows.innerHTML = `<tr><td colspan="8" class="empty">No hay coincidencias</td></tr>`;
      return;
    }

    rows.innerHTML = "";
    filtered.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${p.id||""}</td>
        <td><b>${p.name||""}</b></td>
        <td>${p.category || "<span class='muted'>‚Äî</span>"}</td>
        <td>${eur(p.price)} ‚Ç¨</td>
        <td>${Number(p.stock ?? 0)}</td>
        <td class="muted">${(p.desc || "").toString().slice(0, 70)}${(p.desc||"").length>70?"‚Ä¶":""}</td>
        <td class="muted">${fmtDate(p.updated_at)}</td>
        <td class="actions">
          <button class="iconbtn" title="Editar" onclick="openEdit('${p.id}')">‚úèÔ∏è</button>
        </td>
      `;
      rows.appendChild(tr);
    });
  }

  function setCur(elId, url){
    const node = el(elId);
    if(!url){
      node.textContent = "Actual: -";
    }else{
      node.innerHTML = `Actual: <a href="${url}" target="_blank" rel="noreferrer">ver</a>`;
    }
  }

  window.openEdit = function(id){
    const p = all.find(x => x.id === id);
    if(!p) return;

    current = p;

      isNew = false;
    el("m_id_read").disabled = true;

    
    el("m_id").textContent = `ID: ${p.id}`;
    el("m_id_read").value = p.id || "";
    el("m_name").value = p.name || "";
    el("m_category").value = p.category || "";
    el("m_price").value = (p.price ?? "");
    el("m_stock").value = (p.stock ?? "");
    el("m_desc").value = p.desc || "";

    // Limpia inputs file
    ["m_img1","m_img2","m_img3","m_img4","m_img5"].forEach(x => el(x).value = "");

    // Links actuales
    setCur("m_img1_cur", p.img);
    setCur("m_img2_cur", p.img2);
    setCur("m_img3_cur", p.img3);
    setCur("m_img4_cur", p.img4);
    setCur("m_img5_cur", p.img5);

    overlay.style.display = "flex";
  }

  function closeModal(){
    overlay.style.display = "none";
    current = null;
  }

  async function uploadImage(productId, index1to5, file){
    // Ruta fija por producto + √≠ndice (sobrescribe la imagen si vuelves a subir)
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const path = `products/${productId}/${index1to5}.${ext}`;

    const { error: upErr } = await sb.storage
      .from(BUCKET)
      .upload(path, file, { upsert: true, contentType: file.type });

    if(upErr) throw upErr;

    // URL p√∫blica (bucket p√∫blico)
    const { data } = sb.storage.from(BUCKET).getPublicUrl(path);
    return data.publicUrl;
  }

async function saveModal(){
  const idTyped = (el("m_id_read").value || "").trim();

  // Validaciones m√≠nimas
  if(isNew){
    if(!idTyped) return alert("Pon un ID (ej: p083).");
    if(!/^p\d{3,}$/i.test(idTyped)) return alert("ID sugerido: p083, p120, etc.");
  }

const patch = {
  name: el("m_name").value.trim(),
  category: el("m_category").value.trim() || null,
  price: Number(el("m_price").value || 0),
  stock: Number(el("m_stock").value || 0),
  desc: el("m_desc").value.trim() || null,
  updated_at: new Date().toISOString()
};

  if(!patch.name) return alert("El nombre es obligatorio.");

  try{
    // 1) INSERT o UPDATE primero (para que exista el producto antes de subir im√°genes)
if(isNew){
  const { error } = await sb.from(TABLE_PRODUCTS).insert([ { id: idTyped, ...patch } ]);
  if(error) throw error;
}else{
  const { error } = await sb
    .from(TABLE_PRODUCTS)
    .update(patch)
    .eq("id", current.id);
  if(error) throw error;
}


    const productId = isNew ? idTyped : current.id;

    // 2) Subidas opcionales (si eliges archivo)
    const f1 = el("m_img1").files[0];
    const f2 = el("m_img2").files[0];
    const f3 = el("m_img3").files[0];
    const f4 = el("m_img4").files[0];
    const f5 = el("m_img5").files[0];

    const imgPatch = {};
    if(f1) imgPatch.img  = await uploadImage(productId, 1, f1);
    if(f2) imgPatch.img2 = await uploadImage(productId, 2, f2);
    if(f3) imgPatch.img3 = await uploadImage(productId, 3, f3);
    if(f4) imgPatch.img4 = await uploadImage(productId, 4, f4);
    if(f5) imgPatch.img5 = await uploadImage(productId, 5, f5);

    if(Object.keys(imgPatch).length){
      imgPatch.updated_at = new Date().toISOString();
      const { error: uerr } = await sb
        .from(TABLE_PRODUCTS)
        .update(imgPatch)
        .eq("id", productId);
      if(uerr) throw uerr;
    }

    closeModal();
    await loadProducts();
    alert(isNew ? "‚úÖ Producto creado" : "‚úÖ Producto actualizado");

  }catch(err){
    console.error(err);
    // si el id ya existe, supabase suele decir duplicate key value...
    alert("‚ùå No pude guardar. Mira la consola (F12) para ver el motivo.");
  }
}


  // ===== EVENTS =====



const sortUp = document.getElementById("sortUp");
const sortDown = document.getElementById("sortDown");

function paintSort(){
  sortUp?.classList.toggle("active", sortDir === "asc");
  sortDown?.classList.toggle("active", sortDir === "desc");
}

sortUp?.addEventListener("click", () => {
  sortDir = "asc";
  paintSort();
  applyFilter();
});

sortDown?.addEventListener("click", () => {
  sortDir = "desc";
  paintSort();
  applyFilter();
});



  
document.getElementById("newBtn").addEventListener("click", openNew);
document.getElementById("reloadBtn").addEventListener("click", loadProducts);

document.getElementById("logoutBtn").addEventListener("click", async () => {
  await sb.auth.signOut();
  location.href = "./login.html";
});


  q.addEventListener("input", applyFilter);

  el("m_cancel").addEventListener("click", closeModal);
  overlay.addEventListener("click", (e) => {
    if(e.target === overlay) closeModal();
  });
  el("m_save").addEventListener("click", saveModal);

  // ===== INIT =====
  window.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await sb.auth.getUser();
    if(!user){
      location.href = "./login.html";
      return;
    }

    const ok = await isAdmin();
    if(!ok){
      await sb.auth.signOut();
      alert("Acceso no autorizado");
      location.href = "/";
      return;
    }

    loadProducts();
    paintSort();
  });
</script>
</body>
</html>
