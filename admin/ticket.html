<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ticket</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f3f4f6; --paper:#fff; --txt:#111827; --muted:#6b7280; --border:rgba(0,0,0,.10);
      --shadow:0 12px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;color:var(--txt)}
    .wrap{max-width:920px;margin:0 auto;padding:18px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;
      font-weight:800;display:inline-flex;align-items:center;gap:8px
    }
    .btn.primary{background:#eef2ff;border-color:#c7d2fe}
    .btn.danger{background:#fee2e2;border-color:#fecaca}
    .btn.ok{background:#ecfdf5;border-color:#a7f3d0}
    .row{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}

    /* ‚ÄúPapel‚Äù del ticket */
    .paper{
      width:340px; /* similar a ticket 80mm aprox */
      background:var(--paper);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px 14px 16px;
    }
    .title{text-align:center;font-weight:900;letter-spacing:.8px}
    .muted{color:var(--muted);font-size:12px}
    .center{text-align:center}
    .hr{border-top:1px dashed rgba(0,0,0,.28);margin:10px 0}
    .small{font-size:12px}
    .kv{display:flex;justify-content:space-between;gap:10px;font-size:12px}
    .items{margin-top:8px}
    .item{display:flex;justify-content:space-between;gap:10px;font-size:12px;margin:6px 0}
    .item .name{max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .totals{margin-top:10px}
    .bigTotal{font-size:20px;font-weight:900;letter-spacing:.6px}
    .notice{margin-top:10px;font-size:12px;text-align:center}
    .mono{font-family:inherit}

    /* Panel a la derecha (info + debug) */
    .side{
      flex:1;
      min-width:280px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .side h2{margin:0 0 8px;font-size:14px}
    code{background:#f3f4f6;padding:2px 6px;border-radius:8px}

    /* Modo impresi√≥n */
    @media print{
      body{background:#fff}
      header,.side{display:none !important}
      .wrap{padding:0;margin:0}
      .paper{
        box-shadow:none;border:none;border-radius:0;
        width: 80mm; /* impresora ticket */
        padding: 0;
      }
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn" id="backBtn">‚¨ÖÔ∏è Volver</button>
      <button class="btn ok" id="printBtn">üñ®Ô∏è Imprimir</button>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button class="btn primary" id="reloadBtn">üîÑ Recargar</button>
      <button class="btn danger" id="logoutBtn">üö™ Salir</button>
    </div>
  </header>

  <div class="row">

    <!-- TICKET -->
    <div class="paper" id="paper">
      <div class="title" id="bizName">MAS ENVIOS TELX</div>
      <div class="center small" id="bizLine1">
          C. Noche del Alba, 34<br>
          03206 Elx ¬∑ Alicante
      </div>
      
      <div class="center small" id="bizLine2">üßæ NIF: 78131415R</div>

      <div class="hr"></div>

      <div class="center" style="font-weight:900">- TICKET -</div>

      <div class="hr"></div>

      <div class="kv"><span>Ticket</span><span id="t_ticket">-</span></div>
      <div class="kv"><span>Fecha</span><span id="t_date">-</span></div>
      <div class="kv"><span>Cliente</span><span id="t_customer">-</span></div>
      <div class="kv"><span>Tel√©fono</span><span id="t_phone">-</span></div>

      <div class="hr"></div>

      <div class="items" id="t_items">
        <div class="muted center">Cargando items‚Ä¶</div>
      </div>

      <div class="hr"></div>

      <div class="totals">
        <div class="kv"><span>Items</span><span id="t_qty">-</span></div>
        <div class="kv"><span>Subtotal</span><span id="t_subtotal">-</span></div>
        <div class="kv"><span>Base imponible</span><span id="t_base">-</span></div>
        <div class="kv"><span>IVA (21%)</span><span id="t_vat">-</span></div>

        <div class="hr"></div>

        <div class="kv" style="align-items:baseline">
          <span style="font-weight:900">TOTAL</span>
          <span class="bigTotal" id="t_total">-</span>
        </div>

        <div class="hr"></div>

        <div class="kv"><span>M√©todo pago</span><span id="t_pay">Efectivo / Bizum</span></div>
      </div>

      <div class="notice">
        Se admite cambio en 14 d√≠as presentando el ticket.<br>
        Gracias por su visita üòä
      </div>
    </div>

    </div>

  </div>
</div>

<script>
  // ===== CONFIG (IGUAL QUE EN pedidos.html) =====
  const SUPABASE_URL = "https://pujzkraozoqbriqnlikf.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_D7A6JAiqiXAaPRYsaF6ZBQ_1hCE1UcN";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ===== HELPERS =====
  const $ = (id) => document.getElementById(id);

  function eur(n){
    return `${Number(n || 0).toFixed(2)} ‚Ç¨`;
  }
  function fmtDate(ts){
    if(!ts) return "-";
    return new Date(ts).toLocaleString("es-ES");
  }

  async function isAdmin(){
    const { data: { user } } = await sb.auth.getUser();
    if(!user) return false;

    const { data, error } = await sb
      .from("admins") // tu tabla real
      .select("user_id")
      .eq("user_id", user.id)
      .maybeSingle();

    if(error) return false;
    return !!data;
  }

  function getOrderId(){
    const u = new URL(location.href);
    return u.searchParams.get("id");
  }

  async function loadTicket(){
    const orderId = getOrderId();
    $("debugId").textContent = orderId || "-";

    if(!orderId){
      alert("Falta el id del pedido");
      location.href = "./pedidos.html";
      return;
    }

    // 1) Order
    const { data: order, error: e1 } = await sb
      .from("orders")
      .select("id,ticket_number,customer_name,customer_phone,total,estado,metodo_pago,created_at")
      .eq("id", orderId)
      .maybeSingle();

    if(e1 || !order){
      console.error(e1);
      alert("No pude cargar el pedido (permisos o id inv√°lido).");
      return;
    }

    // 2) Items
    const { data: items, error: e2 } = await sb
      .from("order_items")
      .select("name,price,qty,line_total")
      .eq("order_id", orderId)
      .order("name", { ascending: true });

    if(e2){
      console.error(e2);
      alert("No pude cargar los art√≠culos del pedido.");
      return;
    }

    // ===== RENDER =====
    $("t_ticket").textContent = order.ticket_number || "-";
    $("t_date").textContent   = fmtDate(order.created_at);
    $("t_customer").textContent = (order.customer_name || "-");
    $("t_phone").textContent = (order.customer_phone || "-");

    // Pago (si tienes metodo_pago)
    const mp = (order.metodo_pago || "").toString().toLowerCase();
    $("t_pay").textContent = mp ? mp : "Efectivo / Bizum";

    // Items
    const list = Array.isArray(items) ? items : [];
    const itemsBox = $("t_items");

    if(list.length === 0){
      itemsBox.innerHTML = `<div class="muted center">Sin art√≠culos (order_items vac√≠o)</div>`;
    }else{
      itemsBox.innerHTML = "";
      let totalQty = 0;

      list.forEach(it => {
        const qty = Number(it.qty || 0);
        totalQty += qty;

        const lineTotal = (it.line_total != null) ? Number(it.line_total) : (Number(it.price||0) * qty);

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="name">${(it.name || "Art√≠culo").toString()}</div>
          <div>${qty} x ${eur(it.price)}</div>
          <div>${eur(lineTotal)}</div>
        `;
        itemsBox.appendChild(div);
      });

      $("t_qty").textContent = String(totalQty);
    }

    // Totales + IVA (asumo precios con IVA incluido; si NO, me lo dices y lo ajusto)
    const total = Number(order.total || 0);
    const vatRate = 0.21;
    const base = total / (1 + vatRate);
    const vat  = total - base;

    $("t_total").textContent = eur(total);
    $("t_subtotal").textContent = eur(total);        // (si luego manejas descuentos, aqu√≠ cambia)
    $("t_base").textContent = eur(base);
    $("t_vat").textContent = eur(vat);
  }

  // ===== BUTTONS =====
  $("printBtn").addEventListener("click", () => window.print());
  $("reloadBtn").addEventListener("click", loadTicket);
  $("backBtn").addEventListener("click", () => location.href = "./pedidos.html");
  $("logoutBtn").addEventListener("click", async () => {
    await sb.auth.signOut();
    location.href = "./login.html";
  });

  // ===== INIT =====
  window.addEventListener("DOMContentLoaded", async () => {
    const { data: { user } } = await sb.auth.getUser();
    if(!user){
      location.href = "./login.html";
      return;
    }

    const ok = await isAdmin();
    if(!ok){
      await sb.auth.signOut();
      alert("Acceso no autorizado");
      location.href = "/";
      return;
    }

    loadTicket();
  });
</script>
</body>
</html>
